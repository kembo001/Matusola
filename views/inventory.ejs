<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventory - Wholesale Cars</title>
    <link rel="stylesheet" href="/css/styles.css" />
  </head>
  <body>
    <div class="banner">
      <a href="/" class="banner__title">Wholesale Cars</a>
      <a href="https://maps.app.goo.gl/oiKn7Hk6RhoiGgvX9" target="_blank" class="banner__address">üìç 7820 Riverdale drive NW, Ramsey, MN 55303 </a>
      <a href="tel:763-242-6155" class="banner__phone">üìû (763) 242-6155 </a>
    </div>

    <div class="filters">
      <div class="filters__group">
        <select class="filters__select" name="status" onchange="updateFilters(this)">
          <option value="available" <%= currentStatus === 'available' ? 'selected' : '' %>>Available Vehicles</option>
          <option value="sold" <%= currentStatus === 'sold' ? 'selected' : '' %>>Sold Vehicles</option>
          <option value="all" <%= currentStatus === 'all' ? 'selected' : '' %>>All Vehicles</option>
        </select>
      </div>

      <div class="filters__group">
        <select class="filters__select" name="sort" onchange="updateFilters(this)">
          <option value="newest" <%= currentSort === 'newest' ? 'selected' : '' %>>Newest First</option>
          <option value="price-high" <%= currentSort === 'price-high' ? 'selected' : '' %>>Price: High to Low</option>
          <option value="price-low" <%= currentSort === 'price-low' ? 'selected' : '' %>>Price: Low to High</option>
          <option value="mileage-low" <%= currentSort === 'mileage-low' ? 'selected' : '' %>>Mileage: Low to High</option>
          <option value="mileage-high" <%= currentSort === 'mileage-high' ? 'selected' : '' %>>Mileage: High to Low</option>
        </select>
      </div>
    </div>

    <div class="inventory">
      <% vehicles.forEach(vehicle => { %>
      <div class="inventory__card">
        <div class="inventory__image">
          <div class="inventory__gallery-container">
            <img src="<%= vehicle.image_url %>" alt="<%= vehicle.title %>" loading="lazy" />
          </div>
          <button class="inventory__gallery-prev" style="display: none;">‚Üê</button>
          <button class="inventory__gallery-next" style="display: none;">‚Üí</button>
          <div class="inventory__gallery-loading" style="display: none;">Loading images...</div>
        </div>

        <div class="inventory__content">
          <div class="inventory__info">
            <h2 class="inventory__title"><%= vehicle.title %></h2>
            <p class="inventory__mileage"><%= vehicle.mileage.toLocaleString() %> miles</p>
            <p class="inventory__vin">VIN: <%= vehicle.vin %></p>
          </div>

          <div class="inventory__actions">
            <p class="inventory__price">$<%= vehicle.price.toLocaleString() %></p>
            <button 
              class="inventory__button" 
              onclick="toggleDetails(this)" 
              data-vehicle-id="<%= vehicle.id %>"
              data-images-folder="<%= vehicle.images_folder %>">
              See More
            </button>
          </div>
        </div>

        <div class="inventory__expand">
          <div class="inventory__details">
            <div class="inventory__specs">
              <p class="inventory__spec"><strong>Year:</strong> <%= vehicle.year %></p>
              <p class="inventory__spec"><strong>Make:</strong> <%= vehicle.make %></p>
              <p class="inventory__spec"><strong>Model:</strong> <%= vehicle.model %></p>
              <p class="inventory__spec"><strong>Trim:</strong> <%= vehicle.trim %></p>
              <p class="inventory__spec"><strong>Engine:</strong> <%= vehicle.engine %></p>
              <p class="inventory__spec"><strong>Transmission:</strong> <%= vehicle.transmission %></p>
            </div>
          </div>
        </div>
      </div>
      <% }); %>
    </div>

    <div class="pagination">
      <% if (hasPrevPage) { %>
      <a href="/inventory?page=<%= currentPage - 1 %>&status=<%= currentStatus %>&sort=<%= currentSort %>" class="pagination__button">Previous</a>
      <% } %>

      <span class="pagination__info">Page <%= currentPage %> of <%= totalPages %></span>

      <% if (hasNextPage) { %>
      <a href="/inventory?page=<%= currentPage + 1 %>&status=<%= currentStatus %>&sort=<%= currentSort %>" class="pagination__button">Next</a>
      <% } %>
    </div>

    <script>
    function updateFilters(select) {
      const status = document.querySelector('select[name="status"]').value;
      const sort = document.querySelector('select[name="sort"]').value;
      window.location.href = `/inventory?status=${status}&sort=${sort}`;
    }

    function toggleDetails(button) {
      const card = button.closest('.inventory__card');
      const expandSection = card.querySelector('.inventory__expand');
      const isExpanding = !expandSection.classList.contains('active');
      
      expandSection.classList.toggle('active');
      button.textContent = isExpanding ? 'See Less' : 'See More';
      
      if (isExpanding && !button.dataset.imagesLoaded) {
        const imagesFolder = button.dataset.imagesFolder;
        loadVehicleImages(card, imagesFolder);
        button.dataset.imagesLoaded = 'true';
      }
    }

    function loadVehicleImages(card, imagesFolder) {
      const galleryContainer = card.querySelector('.inventory__gallery-container');
      const loadingEl = card.querySelector('.inventory__gallery-loading');
      const prevBtn = card.querySelector('.inventory__gallery-prev');
      const nextBtn = card.querySelector('.inventory__gallery-next');
      
      loadingEl.style.display = 'block';
      
      const images = [galleryContainer.querySelector('img')];
      
      for(let i = 1; i <= 50; i++) {
        const img = new Image();
        img.src = `https://wholesalecars.sfo3.cdn.digitaloceanspaces.com/${imagesFolder}/${i}.jpg`;
        img.style.display = 'none';
        
        img.onload = () => {
          images.push(img);
          galleryContainer.appendChild(img);
          if (i === 1) {
            loadingEl.style.display = 'none';
            prevBtn.style.display = 'block';
            nextBtn.style.display = 'block';
            setupNavigation(card, images);
          }
        };
        
        img.onerror = () => {
          if (i === 1) loadingEl.style.display = 'none';
          return;
        };
      }
    }

    function setupNavigation(card, images) {
      let currentIndex = 0;
      const prevBtn = card.querySelector('.inventory__gallery-prev');
      const nextBtn = card.querySelector('.inventory__gallery-next');
      
      prevBtn.onclick = () => {
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        images[currentIndex].style.display = 'block';
      };
      
      nextBtn.onclick = () => {
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex + 1) % images.length;
        images[currentIndex].style.display = 'block';
      };
    }
    </script>
  </body>
</html>